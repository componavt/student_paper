%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%             Стилевой файл сборника Труды КарНЦ РАН v 1.14a                %%
%%			   Сделан на основе mmro.sty на правах GPL                       %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%% TODO: \newenvironment

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{krctran}

\ProcessOptions
\RequirePackage{ifthen}
\RequirePackage[cp1251]{inputenc} % набор текста в кодировке WIN-1251
\RequirePackage[T2A]{fontenc} % кириллическая "внутренняя" кодировка
\RequirePackage{amssymb}
\RequirePackage{amsmath} % для принятых в AMS символов в формулах
\RequirePackage{amsthm} % теоремы в стиле AMS - три типа и варианты "со звездочкой"
\RequirePackage{mathrsfs} % каллиграфия в формулах - другой вариант
\RequirePackage{euscript} % рукописные буквы в формулах 
\RequirePackage{array} % таблицы
%\RequirePackage{theorem} % теоремоподобные окружения
\RequirePackage[all]{xy} % для рисования xy-pict
\RequirePackage{graphicx}
\RequirePackage[a4paper,twoside,hmargin={21.5mm,21.5mm},vmargin={25mm,29mm}]{geometry}
\RequirePackage{multicol} % для печати в две колонки и динамического переключения
\RequirePackage{float} % для поддержки печати рисунков сквозь все колонки
\RequirePackage[square,numbers,sort&compress]{natbib} % со 2.04.2012 г. ссылки в виде [номер] вместо [Автор, год]
\RequirePackage{capt-of}

% специальный "флаг" для статей о конференциях и юбилеях
\newboolean{special}
\setboolean{special}{false}
\newcommand{\Special}{\setboolean{special}{true}}

% специальный "флаг" для англоязычных статей
\newboolean{english}
\setboolean{english}{false}
\newcommand{\EngVer}{\setboolean{english}{true}}

% переносы
%\ifthenelse{\boolean{english}}{\RequirePackage[english]{babel}}{\RequirePackage[english,russian]{babel}} 
\RequirePackage[english, russian]{babel}

\tolerance=3000
\hbadness=2000
\clubpenalty=10000
\widowpenalty=10000


% переопределение стандартных размеров шрифтов
\renewcommand{\footnotesize}{\fontsize{9pt}{9pt}\selectfont}
\renewcommand{\small}{\fontsize{10pt}{11pt}\selectfont}
\renewcommand{\normalsize}{\fontsize{11pt}{12pt}\selectfont}
\renewcommand{\large}{\fontsize{12pt}{14pt}\selectfont}
\renewcommand{\Large}{\fontsize{14.4pt}{16pt}\selectfont}
\renewcommand{\baselinestretch}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Оформление заголовочной части статей                                                
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\procname}[1]{\gdef\@procname{{#1}}}
\newcommand{\udk}[1]{\gdef\@udk{{#1}}}

\newcommand{\rusauthor}[1]{\gdef\@rusauthor{{#1}}}
\newcommand{\engauthor}[1]{\gdef\@engauthor{{#1}}}
\newcommand{\rustitle}[1]{\gdef\@rustitle{{#1}}}
\newcommand{\engtitle}[1]{\gdef\@engtitle{{#1}}}
\newcommand{\rusabstract}[1]{\gdef\@rusabstract{{#1}}}
\newcommand{\engabstract}[1]{\gdef\@engabstract{{#1}}}
\newcommand{\ruskeywords}[1]{\gdef\@ruskeywords{{#1}}}
\newcommand{\engkeywords}[1]{\gdef\@engkeywords{{#1}}}

\newcommand{\organization}[1]{\gdef\@organization{{#1}}}

\newcommand{\rusauthorinfo}[1]{\gdef\@rusauthorinfo{{#1}}}
\newcommand{\engauthorinfo}[1]{\gdef\@engauthorinfo{{#1}}}

% сделать неразрывные пробелы ещё и нерастяжимыми (например между фамилией и инициалами авторов)
\newcommand\unstretchspaces{\catcode`~=\active\def~{\;}} 

% длина аннотации статьи (русской и английской)
\newlength\abstractwidth
\setlength{\abstractwidth}{\textwidth}
\addtolength{\abstractwidth}{-40mm}

% длина отступа для четного колонтитула
\newlength\oddleftindent
\setlength{\oddleftindent}{\textwidth}
\addtolength{\oddleftindent}{-129mm}

\setlength{\unitlength}{1mm}



% Вывод заголовка
\def\maketitle{
\ifthenelse{\boolean{english}}
	{
		\@BeginDocument
	    \noindent\parbox{\textwidth}{\small\@procname}\\[20.5mm]
		\noindent\parbox{\textwidth}{\textit\@udk}\\[5mm]
	    \noindent\parbox{\textwidth}{\Large\bfseries\MakeUppercase\@engtitle}\\[4.5mm]
	    \noindent\parbox{\textwidth}{\large\bfseries\@engauthor}\\[3.175mm]
	    \noindent\parbox{\textwidth}{\textit\@organization}\\[19mm]
	    \noindent\parbox{\abstractwidth}{\small\@engabstract}\\[3.175mm]
	    \noindent\parbox{\abstractwidth}{\small{K\,e\,y~~w\,o\,r\,d\,s: }\@engkeywords}\\[5mm]
	    \noindent\parbox{\abstractwidth}{\bfseries\@rusauthor. \MakeUppercase\@rustitle}\\[3.175mm]
	    \noindent\parbox{\abstractwidth}{\small\@rusabstract}\\[3.175mm]
	    \noindent\parbox{\abstractwidth}{\small{К\,л\,ю\,ч\,е\,в\,ы\,е~~c\,л\,о\,в\,а: }\@ruskeywords}\\[1mm]
	    \rule{\abstractwidth}{\linethickness}\\[1mm]
	}
	{
	\ifthenelse{\boolean{special}}
	    {
		    \@BeginDocument
		    \noindent\parbox{\textwidth}{\small\@procname}\\[30.5mm]
		    \noindent\parbox{\textwidth}{\begin{center}\Large\bfseries\MakeUppercase\@rustitle\end{center}}\\[20.5mm]
	    }
	    {
		    \@BeginDocument
		    \noindent\parbox{\textwidth}{\small\@procname}\\[20.5mm]
			\noindent\parbox{\textwidth}{\textit\@udk}\\[5mm]
		    \noindent\parbox{\textwidth}{\Large\bfseries\MakeUppercase\@rustitle}\\[4.5mm]
		    \noindent\parbox{\textwidth}{\large\bfseries\@rusauthor}\\[3.175mm]
		    \noindent\parbox{\textwidth}{\textit\@organization}\\[19mm]
		    \noindent\parbox{\abstractwidth}{\small\@rusabstract}\\[3.175mm]
		    \noindent\parbox{\abstractwidth}{\small{К\,л\,ю\,ч\,е\,в\,ы\,е~~c\,л\,о\,в\,а: }\@ruskeywords}\\[5mm]
		    \noindent\parbox{\abstractwidth}{\bfseries\@engauthor. \MakeUppercase\@engtitle}\\[3.175mm]
		    \noindent\parbox{\abstractwidth}{\small\@engabstract}\\[3.175mm]
		    \noindent\parbox{\abstractwidth}{\small{K\,e\,y~~w\,o\,r\,d\,s: }\@engkeywords}\\[1mm]
		    \rule{\abstractwidth}{\linethickness}\\[1mm]
	    }
    }
}

% Новое окружение - основной текст статьи (двухколоночный режим)
\setlength{\columnsep}{5mm}
\newenvironment{articletext}{\begin{multicols}{2}\normalsize}%
				{\end{multicols}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Переопределение колонтитулов
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\ps@headings}{%
    \renewcommand{\@oddfoot}{\rule{120mm}{\linethickness}\put(4.4,0){\circle{9}\makebox(0,0){\thepage}}}%
    \renewcommand{\@oddhead}{}%
    \renewcommand{\@evenfoot}{\makebox[\oddleftindent]{}\put(4.5,0){\circle{9}\makebox(0,0){\thepage}}\put(9,0){\rule{120mm}{\linethickness}}}%
    \renewcommand{\@evenhead}{}%
}
\pagestyle{empty}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Оформление разделов
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Настройка разделов
% Разделы в стилевом файле по юбилеям (Список основных работ юбиляра) по центру
\ifthenelse{\boolean{special}}{\newcommand\typeSection[1]{\bigskip\noindent\centering{\textbf{\textsc{#1}}}\par\medskip}}%
{\newcommand\typeSection[1]{\bigskip\noindent{\textbf{\textsc{#1}}}\par\medskip}}

\newcommand\typeSubSection[1]{\medskip\noindent{\textbf{#1}}\par\smallskip}
\newcommand\typeParagraph[1]{\smallskip\noindent{\bfseries #1}}

% Разделы
\renewcommand\section[1]{\par\typeSection{#1}}
\renewcommand\subsection[1]{\par\typeSubSection{#1}}
\renewcommand\subsubsection[1]{\par\typeSubSection{#1}}
\renewcommand\paragraph[1]{\par\typeParagraph{#1}\nobreak}
\renewcommand\subparagraph[1]{\par\typeParagraph{#1}\nobreak}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Оформление библиографии - natbib - Со 2.04.2012 команды не используются
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% Оформление элементов пункта библиографии
%\let\oldthebibliography=\thebibliography
%\let\endoldthebibliography=\endthebibliography
%\renewenvironment{thebibliography}[1]{%
%\begin{oldthebibliography}{#1}% 
%%\setlength{\parskip}{0ex}%
%\setlength{\itemsep}{0ex}%
%\small
%}%
%{%
%\end{oldthebibliography}%
%}

%\bibpunct{[}{]}{;}{a}{,}{,}
%\renewcommand\cite[1]{\citep{#1}}
%\def\typeBibItem{\small\sloopy}

\renewcommand\@biblabel[1]{#1.}
% Переопределение горизонтальных и вертикальных промежутков в списке литературы
\renewenvironment{thebibliography}[1]
    {\section{\ifthenelse{\boolean{english}}{References}{\bibname}}%
        \list{\@biblabel{\@arabic\c@enumiv}}{%
            \settowidth\labelwidth{\@biblabel{#1}}%
            \leftmargin\labelwidth%
            \setlength\itemindent{\parindent}%
            \topsep=0pt\parsep=0pt\itemsep=1ex %
            \@openbib@code
        }%
        \small
        %\typeBibItem
    }{%
        \def\@noitemerr{\@latex@warning{Empty `thebibliography' environment}}%
        \endlist
    }
    
\newenvironment{thebibliographyen}[1]
    {\section{References}%
	\setcounter{NAT@ctr}{0}
        \list{\@biblabel{\@arabic\c@enumiv}}{%
            \settowidth\labelwidth{\@biblabel{#1}}%
            \leftmargin\labelwidth%
            \setlength\itemindent{\parindent}%
            \topsep=0pt\parsep=0pt\itemsep=1ex %
            \@openbib@code%
        }%
        \small
        %\typeBibItem
    }{%
        \def\@noitemerr{\@latex@warning{Empty `thebibliography' environment}}%
        \endlist
    }

%% Действия, которые делаются в начале каждой статьи
\newcommand{\@BeginDocument}{
    \pagestyle{headings}%
    \renewcommand{\theenumii}{\asbuk{enumii}}%
    % Обнуление счётчиков
    \setcounter{equation}{0}%
    \setcounter{table}{0}%
    \setcounter{figure}{0}%
    \setcounter{footnote}{0}%
    \setcounter{Theorem}{0}%
    \setcounter{Lemma}{0}%
	\setcounter{State}{0}%
    \setcounter{Corollary}{0}%
	\setcounter{Axiom}{0}%
    \setcounter{Definition}{0}%
    \setcounter{Example}{0}%
    \setcounter{Remark}{0}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Финальные заметки об авторах
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% оформление имени автора
\newcommand\authorsname[1]{%
\ifthenelse{\boolean{special}}
{\flushright{\it #1}}
{\noindent{\footnotesize\bfseries #1}\newline}}

% на последней странице нет линейки и нумерации
\newcommand\lastpage{\thispagestyle{empty}}
\newenvironment{aboutauthors}{\thispagestyle{empty}~\\[-13mm]\begin{multicols}{2}\footnotesize}%
				{\end{multicols}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Для включения графиков пакетом graphicx
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\DeclareGraphicsRule{.wmf}{bmp}{}{}
%\DeclareGraphicsRule{.emf}{bmp}{}{}
%\DeclareGraphicsRule{.bmp}{bmp}{}{}
%\DeclareGraphicsRule{.png}{bmp}{}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Плавающие иллюстрации
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{topnumber}{9}
\setcounter{totalnumber}{9}
\renewcommand\topfraction{1.0}

\setlength\floatsep{2ex}
\setlength\textfloatsep{2.5ex}
\setlength\intextsep{2.5ex}
\setlength\abovecaptionskip{2ex}
\setlength\belowcaptionskip{2ex}

%\def\@caption@left@right@skip{\leftskip=3.5ex\rightskip=3.5ex}
%\def\nocaptionskips{\def\@caption@left@right@skip{}}

\renewcommand\@makecaption[2]{%
    \vskip\abovecaptionskip
    \sbox\@tempboxa{\small\textit{#1.} #2}%
    \ifdim\wd\@tempboxa >\hsize
        {\small\textit{#1.} #2\par}
    \else
        \global\@minipagefalse
        \hb@xt@\hsize{\box\@tempboxa\hfil}%
    \fi
    \vskip\belowcaptionskip
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Некоторые переопределения для унификации математики
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\ge}{\geqslant}
\renewcommand{\le}{\leqslant}
\renewcommand{\emptyset}{\varnothing}
\renewcommand{\kappa}{\varkappa}
\renewcommand{\phi}{\varphi}
\renewcommand{\epsilon}{\varepsilon}

\renewcommand{\vec}[1]{\mathbf{#1}}
\renewcommand{\complement}{\mathsf{C}}
\newcommand{\T}{^{\text{\rm т}}}

\newcommand\myop[1]{\mathop{\operator@font #1}\nolimits}
\newcommand\mylim[1]{\mathop{\operator@font #1}\limits}

\renewcommand\lim{\mylim{lim}}
\renewcommand\limsup{\mylim{lim\,sup}}
\renewcommand\liminf{\mylim{lim\,inf}}
\renewcommand\max{\mylim{max}}
\renewcommand\min{\mylim{min}}
\renewcommand\sup{\mylim{sup}}
\renewcommand\inf{\mylim{inf}}
\newcommand\argmin{\mylim{arg\,min}}
\newcommand\argmax{\mylim{arg\,max}}
\newcommand\Tr{\myop{tr}}
\newcommand\rank{\myop{rank}}
\newcommand\diag{\myop{diag}}
\newcommand\sign{\mylim{sign}}
\newcommand\const{\myop{const}}

% теория вероятностей
\newcommand{\erf}{\myop{erf}}
\newcommand{\Expect}{\mathsf{E}}
\newcommand{\Var}{\mathsf{D}}
\newcommand\Normal{\mathcal{N}}
\newcommand{\cond}{\mspace{3mu}{|}\mspace{3mu}}

\def\QQ{\mathbb{Q}}
\def\RR{\mathbb{R}}
\def\NN{\mathbb{N}}
\def\ZZ{\mathbb{Z}}
\def\LL{\mathbb{L}}
\def\II{\mathbb{I}}
\def\DD{\mathbb{D}}

\def\cL{\mathscr{L}}
\def\cF{\mathscr{F}}
\def\cG{\mathscr{G}}
\def\cB{\mathscr{B}}
\def\cK{\mathscr{K}}

\def\cJ{\mathcal{J}}
\def\cN{\mathcal{N}}

\def\fF{\mathfrak{F}}
\def\fI{\mathfrak{I}}
\def\fM{\mathfrak{M}}
\def\fR{\mathfrak{R}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Новые теоремоподобные окружения
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\boolean{english}}
{
	\theoremstyle{plain} % Теоремы наклонным шрифтом
	\newtheorem{Theorem}{Theorem}
	\newtheorem{Lemma}{Lemma}
	\newtheorem{State}{State}
	\newtheorem{Corollary}{Corollary}
	\newtheorem{Axiom}{Axiom}
	\theoremstyle{definition} % Теоремы прямым шрифтом
	\newtheorem{Definition}{Definition}
	\newtheorem{Example}{Example}
	\newtheorem{Remark}{Remark}
	\theoremstyle{plain} % Версии "со звездочкой" % Теоремы наклонным шрифтом
	\newtheorem*{Theorem*}{Theorem}
	\newtheorem*{Lemma*}{Lemma}
	\newtheorem*{State*}{State}
	\newtheorem*{Corollary*}{Corollary}
	\newtheorem*{Axiom*}{Axiom}
	\theoremstyle{definition} % Теоремы прямым шрифтом
	\newtheorem*{Definition*}{Definition}
	\newtheorem*{Example*}{Example}
	\newtheorem*{Remark*}{Remark}
}
{
	\theoremstyle{plain} % Теоремы наклонным шрифтом
	\newtheorem{Theorem}{Теорема}
	\newtheorem{Lemma}{Лемма}
	\newtheorem{State}{Утверждение}
	\newtheorem{Corollary}{Следствие}
	\newtheorem{Axiom}{Аксиома}
	\theoremstyle{definition} % Теоремы прямым шрифтом
	\newtheorem{Definition}{Определение}
	\newtheorem{Example}{Пример}
	\newtheorem{Remark}{Замечание}
	\theoremstyle{plain} % Версии "со звездочкой" % Теоремы наклонным шрифтом
	\newtheorem*{Theorem*}{Теорема}
	\newtheorem*{Lemma*}{Лемма}
	\newtheorem*{State*}{Утверждение}
	\newtheorem*{Corollary*}{Следствие}
	\newtheorem*{Axiom*}{Аксиома}
	\theoremstyle{definition} % Теоремы прямым шрифтом
	\newtheorem*{Definition*}{Определение}
	\newtheorem*{Example*}{Пример}
	\newtheorem*{Remark*}{Замечание}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%   П Р О Ч Е Е
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Выделение - всегда курсивом
\renewcommand\emph[1]{\textit{#1}}

% Формулы, таблицы, рисунки на всю ширину
\newcommand\bfullwidth{\end{multicols}}
\newcommand\efullwidth{\begin{multicols}{2}}
